# 数据流说明

## 资产数据获取流程

### 1. 初始化流程

```
用户打开插件
  ↓
AssetProvider 加载
  ↓
从 Chrome Storage 读取配置
  ├─ 交易所配置
  ├─ 钱包配置
  └─ 应用设置
  ↓
useAssetFetcher Hook 初始化
  ↓
检查资产缓存（assetCache）
  ├─ 有缓存且有效？
  │   ├─ 是 → 显示缓存数据
  │   └─ 否 → 继续获取流程
  └─ 无缓存 → 继续获取流程
```

### 2. 资产获取流程

```
fetchAssets() 调用
  ↓
并行获取：
├─ CEX 资产获取
│   ├─ Binance 资产
│   │   ├─ Spot 账户
│   │   ├─ Earn 资产
│   │   └─ Staking 资产
│   └─ OKX 资产
│       ├─ Funding 账户
│       └─ Trading 账户
│
├─ 链上资产获取
│   ├─ 原生代币余额
│   ├─ ERC-20 代币余额（Multicall）
│   └─ 代币元数据
│
└─ DeFi 协议资产
    ├─ EigenLayer
    ├─ Aerodrome
    ├─ Aave
    └─ Stargate
  ↓
合并所有资产
  ↓
获取价格数据
  ↓
计算资产价值
  ↓
应用过滤规则（隐藏小额资产）
  ↓
按价值排序
  ↓
保存到缓存（assetCache）
  ↓
更新 UI
```

### 3. 价格获取流程

```
需要价格数据
  ↓
检查汇率缓存（ratesCache）
  ├─ 有缓存且有效？
  │   ├─ 是 → 使用缓存价格
  │   └─ 否 → 继续获取
  └─ 无缓存 → 继续获取
  ↓
并行获取价格：
├─ Binance Price API
│   └─ 批量查询或单个查询
├─ CryptoCompare
│   └─ BTC 价格
└─ DeFiLlama
    └─ 链上代币价格
  ↓
合并价格数据
  ↓
保存到缓存（ratesCache）
  ↓
更新 UI
```

## 数据存储流程

### 配置数据存储

```
用户操作（添加/删除/修改）
  ↓
AssetProvider Context 更新
  ↓
useEffect 监听变化
  ↓
保存到 Chrome Storage
  ├─ 交易所配置
  ├─ 钱包配置
  └─ 应用设置
  ↓
持久化完成
```

### 缓存数据存储

```
获取到新数据
  ↓
验证数据有效性
  ↓
创建缓存对象
  ├─ 数据内容
  └─ 时间戳
  ↓
保存到 Chrome Storage
  ├─ assetCache（24小时）
  └─ ratesCache（30分钟）
  ↓
缓存完成
```

## 数据更新流程

### 手动刷新

```
用户点击刷新按钮
  ↓
refresh() 函数调用
  ↓
清除资产缓存（assetCache.clear()）
  ↓
设置 isInitialLoad = false
  ↓
调用 fetchAssets(true)
  ↓
强制获取最新数据
  ↓
更新缓存和 UI
```

### 自动更新

```
定时任务（可选）
  ↓
检查缓存过期时间
  ├─ 已过期？
  │   ├─ 是 → 后台更新
  │   └─ 否 → 跳过
  └─ 未过期 → 跳过
  ↓
静默更新数据
  ↓
更新缓存
  ↓
不触发 UI 更新（避免闪烁）
```

## 数据过滤流程

### 小额资产过滤

```
资产列表
  ↓
检查设置（settings.hideSmallAssets）
  ├─ 启用？
  │   ├─ 是 → 应用过滤
  │   └─ 否 → 显示所有
  └─ 未启用 → 显示所有
  ↓
过滤条件：
valueUsd >= settings.smallAssetsThreshold
  ↓
过滤后的资产列表
  ↓
更新 UI
```

### 价格匹配流程

```
资产列表
  ↓
提取所有代币符号
  ↓
尝试匹配价格：
├─ 直接匹配（完整符号）
├─ 基础符号匹配（去除后缀）
└─ 映射匹配（特殊符号映射）
  ↓
找到价格？
  ├─ 是 → 计算价值
  └─ 否 → 显示 $0.00
  ↓
更新资产价值
```

## 数据聚合流程

### 按币种聚合

```
资产列表
  ↓
按 symbol 分组
  ↓
合并相同币种：
├─ 数量相加
├─ 价值相加
└─ 来源合并
  ↓
聚合后的资产列表
```

### 按账户分组

```
资产列表
  ↓
按 source 分组
  ├─ 交易所账户
  ├─ 钱包地址
  └─ DeFi 协议
  ↓
每个账户的资产列表
  ↓
用于标签页显示
```

## 数据同步流程

### 多标签页同步

```
标签页 A 修改配置
  ↓
保存到 Chrome Storage
  ↓
Chrome Storage 事件触发
  ↓
其他标签页监听事件
  ↓
重新加载配置
  ↓
更新 UI
```

### 设置变更同步

```
用户修改设置
  ↓
updateSettings() 调用
  ↓
Context 状态更新
  ↓
保存到 Chrome Storage
  ↓
触发相关组件更新
  ├─ 资产列表（过滤规则）
  ├─ 语言切换（i18n）
  └─ 主题切换（theme）
  ↓
UI 更新
```

## 错误处理流程

### API 错误处理

```
API 请求
  ↓
请求失败？
  ├─ 是 → 错误处理
  └─ 否 → 继续处理
  ↓
错误类型判断：
├─ 网络错误
│   └─ 显示错误提示，使用缓存
├─ 认证错误
│   └─ 显示用户友好提示
├─ 限流错误
│   └─ 延迟重试
└─ 其他错误
    └─ 记录日志，跳过
  ↓
继续处理其他数据源
  ↓
部分数据可用时仍显示
```

### 数据验证流程

```
获取到数据
  ↓
验证数据格式
  ├─ 类型检查
  ├─ 必填字段检查
  └─ 数值范围检查
  ↓
数据有效？
  ├─ 是 → 继续处理
  └─ 否 → 丢弃数据，记录日志
  ↓
数据清洗
  ├─ 去除无效数据
  ├─ 格式化数值
  └─ 标准化符号
  ↓
保存到状态
```

